"use strict";var L=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var se=(e,n)=>{for(var l in n)L(e,l,{get:n[l],enumerable:!0})},ae=(e,n,l,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let f of ne(n))!ie.call(e,f)&&f!==l&&L(e,f,{get:()=>n[f],enumerable:!(o=re(n,f))||o.enumerable});return e};var oe=e=>ae(L({},"__esModule",{value:!0}),e);var _e={};se(_e,{convertFromDB:()=>qe,convertToDB:()=>Se,createFieldAttribute:()=>Oe,createInternalAdapter:()=>Fe,getAdapter:()=>Ue,getAuthTables:()=>v,getMigrations:()=>Me,getSchema:()=>j,getWithHooks:()=>V,matchType:()=>ee,toZodSchema:()=>De});module.exports=oe(_e);var E=(e,n="ms")=>new Date(Date.now()+(n==="sec"?e*1e3:e));var h=require("zod"),de=require("better-call"),He=h.z.object({id:h.z.string(),providerId:h.z.string(),accountId:h.z.string(),userId:h.z.string(),accessToken:h.z.string().nullish(),refreshToken:h.z.string().nullish(),idToken:h.z.string().nullish(),accessTokenExpiresAt:h.z.date().nullish(),refreshTokenExpiresAt:h.z.date().nullish(),scope:h.z.string().nullish(),password:h.z.string().nullish(),image:h.z.string().nullish(),createdAt:h.z.date().default(()=>new Date),updatedAt:h.z.date().default(()=>new Date)}),$e=h.z.object({id:h.z.string(),email:h.z.string().transform(e=>e.toLowerCase()),emailVerified:h.z.boolean().default(!1),name:h.z.string(),image:h.z.string().nullish(),createdAt:h.z.date().default(()=>new Date),updatedAt:h.z.date().default(()=>new Date)}),Ke=h.z.object({id:h.z.string(),userId:h.z.string(),expiresAt:h.z.date(),createdAt:h.z.date().default(()=>new Date),updatedAt:h.z.date().default(()=>new Date),token:h.z.string(),ipAddress:h.z.string().nullish(),userAgent:h.z.string().nullish()}),We=h.z.object({id:h.z.string(),value:h.z.string(),createdAt:h.z.date().default(()=>new Date),updatedAt:h.z.date().default(()=>new Date),expiresAt:h.z.date(),identifier:h.z.string()});function H(e,n){let l=n.fields,o={};for(let f in e){let g=l[f];if(!g){o[f]=e[f];continue}g.returned!==!1&&(o[f]=e[f])}return o}function $(e,n){let l={...n==="user"?e.user?.additionalFields:{},...n==="session"?e.session?.additionalFields:{}};for(let o of e.plugins||[])o.schema&&o.schema[n]&&(l={...l,...o.schema[n].fields});return l}function P(e,n){let l=$(e,"user");return H(n,{fields:l})}function N(e,n){let l=$(e,"session");return H(n,{fields:l})}function V(e,n){let l=n.hooks;async function o(d,m,t){let r=d;for(let c of l||[]){let u=c[m]?.create?.before;if(u){let s=await u(d);if(s===!1)return null;typeof s=="object"&&"data"in s&&(r=s.data)}}let i=t?await t.fn(r):null,a=!t||t.executeMainFn?await e.create({model:m,data:r}):i;for(let c of l||[]){let u=c[m]?.create?.after;u&&await u(a)}return a}async function f(d,m,t,r){let i=d;for(let u of l||[]){let s=u[t]?.update?.before;if(s){let p=await s(d);if(p===!1)return null;i=typeof p=="object"?p.data:p}}let a=r?await r.fn(i):null,c=!r||r.executeMainFn?await e.update({model:t,update:i,where:m}):a;for(let u of l||[]){let s=u[t]?.update?.after;s&&await s(c)}return c}async function g(d,m,t,r){let i=d;for(let u of l||[]){let s=u[t]?.update?.before;if(s){let p=await s(d);if(p===!1)return null;i=typeof p=="object"?p.data:p}}let a=r?await r.fn(i):null,c=!r||r.executeMainFn?await e.updateMany({model:t,update:i,where:m}):a;for(let u of l||[]){let s=u[t]?.update?.after;s&&await s(c)}return c}return{createWithHooks:o,updateWithHooks:f,updateManyWithHooks:g}}var U=Object.create(null),O=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?U:globalThis),K=new Proxy(U,{get(e,n){return O()[n]??U[n]},has(e,n){let l=O();return n in l||n in U},set(e,n,l){let o=O(!0);return o[n]=l,!0},deleteProperty(e,n){if(!n)return!1;let l=O(!0);return delete l[n],!0},ownKeys(){let e=O(!0);return Object.keys(e)}});function ue(e){return e?e!=="false":!1}var le=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var W=le==="test"||ue(K.TEST);function J(e,n){if(n.advanced?.ipAddress?.disableIpTracking)return null;let l="127.0.0.1";if(W)return l;let f=n.advanced?.ipAddress?.ipAddressHeaders||["x-client-ip","x-forwarded-for","cf-connecting-ip","fastly-client-ip","x-real-ip","x-cluster-client-ip","x-forwarded","forwarded-for","forwarded"],g=e instanceof Request?e.headers:e;for(let d of f){let m=g.get(d);if(typeof m=="string"){let t=m.split(",")[0].trim();if(t)return t}}return null}function S(e){try{return JSON.parse(e)}catch{return null}}var z=require("@better-auth/utils/random"),F=e=>(0,z.createRandomStringGenerator)("a-z","A-Z","0-9")(e||32);var be=require("zod"),ve=require("better-call");var D=class extends Error{constructor(n,l){super(n),this.name="BetterAuthError",this.message=n,this.cause=l,this.stack=""}};var he=require("@better-auth/utils/hash"),xe=require("@noble/ciphers/chacha"),M=require("@noble/ciphers/utils"),we=require("@noble/ciphers/webcrypto");var fe=require("@better-auth/utils/hash");var pe=require("jose");var me=require("@noble/hashes/scrypt"),ye=require("uncrypto"),ge=require("@better-auth/utils/hex");var G=require("@better-auth/utils/random"),Ae=(0,G.createRandomStringGenerator)("a-z","0-9","A-Z","-_");var _=["info","success","warn","error","debug"];function Te(e,n){return _.indexOf(n)<=_.indexOf(e)}var b={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},ke={info:b.fg.blue,success:b.fg.green,warn:b.fg.yellow,error:b.fg.red,debug:b.fg.magenta},Re=(e,n)=>{let l=new Date().toISOString();return`${b.dim}${l}${b.reset} ${ke[e]}${e.toUpperCase()}${b.reset} ${b.bright}[Better Auth]:${b.reset} ${n}`},C=e=>{let n=e?.disabled!==!0,l=e?.level??"error",o=(f,g,d=[])=>{if(!n||!Te(l,f))return;let m=Re(f,g);if(!e||typeof e.log!="function"){f==="error"?console.error(m,...d):f==="warn"?console.warn(m,...d):console.log(m,...d);return}e.log(f==="success"?"info":f,m,...d)};return Object.fromEntries(_.map(f=>[f,(...[g,...d])=>o(f,g,d)]))},Z=C();var Fe=(e,n)=>{let l=n.options,o=l.secondaryStorage,f=l.session?.expiresIn||60*60*24*7,{createWithHooks:g,updateWithHooks:d,updateManyWithHooks:m}=V(e,n);return{createOAuthUser:async(t,r)=>{let i=await g({createdAt:new Date,updatedAt:new Date,...t},"user"),a=await g({...r,userId:i.id||t.id,createdAt:new Date,updatedAt:new Date},"account");return{user:i,account:a}},createUser:async t=>await g({createdAt:new Date,updatedAt:new Date,emailVerified:!1,...t,email:t.email.toLowerCase()},"user"),createAccount:async t=>await g({createdAt:new Date,updatedAt:new Date,...t},"account"),listSessions:async t=>{if(o){let i=await o.get(`active-sessions-${t}`);if(!i)return[];let a=S(i)||[],c=Date.now(),u=a.filter(p=>p.expiresAt>c),s=[];for(let p of u){let A=await o.get(p.token);if(A){let y=JSON.parse(A),w=N(n.options,{...y.session,expiresAt:new Date(y.session.expiresAt)});s.push(w)}}return s}return await e.findMany({model:"session",where:[{field:"userId",value:t}]})},listUsers:async(t,r,i,a)=>await e.findMany({model:"user",limit:t,offset:r,sortBy:i,where:a}),deleteUser:async t=>{await e.deleteMany({model:"session",where:[{field:"userId",value:t}]}),await e.deleteMany({model:"account",where:[{field:"userId",value:t}]}),await e.delete({model:"user",where:[{field:"id",value:t}]})},createSession:async(t,r,i,a)=>{let c=r instanceof Request?r.headers:r,{id:u,...s}=a||{},p={ipAddress:r&&J(r,n.options)||"",userAgent:c?.get("user-agent")||"",...s,expiresAt:i?E(60*60*24,"sec"):E(f,"sec"),userId:t,token:F(32),createdAt:new Date,updatedAt:new Date};return await g(p,"session",o?{fn:async y=>{let w=await o.get(`active-sessions-${t}`),x=[],R=Date.now();return w&&(x=S(w)||[],x=x.filter(te=>te.expiresAt>R)),x.push({token:p.token,expiresAt:R+f*1e3}),await o.set(`active-sessions-${t}`,JSON.stringify(x),f),y},executeMainFn:l.session?.storeSessionInDatabase}:void 0)},findSession:async t=>{if(o){let u=await o.get(t);if(u){let s=JSON.parse(u),p=N(n.options,{...s.session,expiresAt:new Date(s.session.expiresAt),createdAt:new Date(s.session.createdAt),updatedAt:new Date(s.session.updatedAt)}),A=P(n.options,{...s.user,createdAt:new Date(s.user.createdAt),updatedAt:new Date(s.user.updatedAt)});return{session:p,user:A}}}let r=await e.findOne({model:"session",where:[{value:t,field:"token"}]});if(!r)return null;let i=await e.findOne({model:"user",where:[{value:r.userId,field:"id"}]});if(!i)return null;let a=N(n.options,r),c=P(n.options,i);return o&&await o?.set(t,JSON.stringify({session:a,user:c}),a.expiresAt?Math.floor(((a.expiresAt instanceof Date?a.expiresAt.getTime():new Date(a.expiresAt).getTime())-Date.now())/1e3):f),{session:a,user:c}},findSessions:async t=>{if(o){let c=[];for(let u of t){let s=await o.get(u);if(s){let p=JSON.parse(s),A={session:{...p.session,expiresAt:new Date(p.session.expiresAt)},user:{...p.user,createdAt:new Date(p.user.createdAt),updatedAt:new Date(p.user.updatedAt)}};c.push(A)}}return c}let r=await e.findMany({model:"session",where:[{field:"token",value:t,operator:"in"}]}),i=r.map(c=>c.userId);if(!i.length)return[];let a=await e.findMany({model:"user",where:[{field:"id",value:i,operator:"in"}]});return r.map(c=>{let u=a.find(s=>s.id===c.userId);return u?{session:c,user:u}:null})},updateSession:async(t,r)=>await d(r,[{field:"token",value:t}],"session",o?{async fn(a){let c=await o.get(t),u=null;return c?(u={...JSON.parse(c).session,...a},u):null},executeMainFn:l.session?.storeSessionInDatabase}:void 0),deleteSession:async t=>{if(o){await o.delete(t),l.session?.storeSessionInDatabase&&await e.delete({model:"session",where:[{field:"token",value:t}]});return}await e.delete({model:"session",where:[{field:"token",value:t}]})},deleteAccounts:async t=>{await e.deleteMany({model:"account",where:[{field:"userId",value:t}]})},deleteSessions:async t=>{if(o){if(typeof t=="string"){let r=await o.get(`active-sessions-${t}`),i=r?S(r):[];if(!i)return;for(let a of i)await o.delete(a.token)}else for(let r of t)await o.get(r)&&await o.delete(r);l.session?.storeSessionInDatabase&&await e.deleteMany({model:"session",where:[{field:Array.isArray(t)?"token":"userId",value:t,operator:Array.isArray(t)?"in":void 0}]});return}await e.deleteMany({model:"session",where:[{field:Array.isArray(t)?"token":"userId",value:t,operator:Array.isArray(t)?"in":void 0}]})},findOAuthUser:async(t,r,i)=>{let a=null;if(a=await e.findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]}),!a){let u=await e.findOne({model:"account",where:[{value:r,field:"accountId"},{value:i,field:"providerId"}]});return u?(a=await e.findOne({model:"user",where:[{value:u.userId,field:"id"}]}),{user:a,accounts:[u]}):null}let c=await e.findMany({model:"account",where:[{value:a.id,field:"userId"}]});return{user:a,accounts:c||[]}},findUserByEmail:async(t,r)=>{let i=await e.findOne({model:"user",where:[{value:t.toLowerCase(),field:"email"}]});if(!i)return null;if(r?.includeAccounts){let a=await e.findMany({model:"account",where:[{value:i.id,field:"userId"}]});return{user:i,accounts:a}}return{user:i,accounts:[]}},findUserById:async t=>await e.findOne({model:"user",where:[{field:"id",value:t}]}),linkAccount:async t=>await g({...t,createdAt:new Date,updatedAt:new Date},"account"),updateUser:async(t,r)=>await d(r,[{field:"id",value:t}],"user"),updateUserByEmail:async(t,r)=>await d(r,[{field:"email",value:t}],"user"),updatePassword:async(t,r)=>{await m({password:r},[{field:"userId",value:t},{field:"providerId",value:"credential"}],"account")},findAccounts:async t=>await e.findMany({model:"account",where:[{field:"userId",value:t}]}),findAccount:async t=>await e.findOne({model:"account",where:[{field:"accountId",value:t}]}),findAccountByUserId:async t=>await e.findMany({model:"account",where:[{field:"userId",value:t}]}),updateAccount:async(t,r)=>await d(r,[{field:"id",value:t}],"account"),createVerificationValue:async t=>await g({createdAt:new Date,updatedAt:new Date,...t},"verification"),findVerificationValue:async t=>(await e.findMany({model:"verification",where:[{field:"identifier",value:t}],sortBy:{field:"createdAt",direction:"desc"},limit:1}))[0],deleteVerificationValue:async t=>{await e.delete({model:"verification",where:[{field:"id",value:t}]})},deleteVerificationByIdentifier:async t=>{await e.delete({model:"verification",where:[{field:"identifier",value:t}]})},updateVerificationValue:async(t,r)=>await d(r,[{field:"id",value:t}],"verification")}};var Oe=(e,n)=>({type:e,...n});var v=e=>{let n=e.plugins?.reduce((t,r)=>{let i=r.schema;if(!i)return t;for(let[a,c]of Object.entries(i))t[a]={fields:{...t[a]?.fields,...c.fields},modelName:c.modelName||a};return t},{}),l=e.rateLimit?.storage==="database",o={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:f,session:g,account:d,...m}=n||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...f?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...g?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...d?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...m,...l?o:{}}};var k=require("zod");function De(e){return k.z.object({...Object.keys(e).reduce((l,o)=>{let f=e[o];if(!f)return l;if(f.type==="string[]"||f.type==="number[]")return{...l,[o]:k.z.array(f.type==="string[]"?k.z.string():k.z.number())};if(Array.isArray(f.type))return{...l,[o]:k.z.any()};let g=k.z[f.type]();return f?.required===!1&&(g=g.optional()),f?.returned===!1?l:{...l,[o]:g}},{})})}var I=require("kysely"),T=require("kysely");function Q(e){if(!e)return null;if("dialect"in e)return Q(e.dialect);if("createDriver"in e){if(e instanceof T.SqliteDialect)return"sqlite";if(e instanceof T.MysqlDialect)return"mysql";if(e instanceof T.PostgresDialect)return"postgres";if(e instanceof I.MssqlDialect)return"mssql"}return"aggregate"in e?"sqlite":"getConnection"in e?"mysql":"connect"in e?"postgres":null}var q=async e=>{let n=e.database;if(!n)return{kysely:null,databaseType:null};if("db"in n)return{kysely:n.db,databaseType:n.type};if("dialect"in n)return{kysely:new I.Kysely({dialect:n.dialect}),databaseType:n.type};let l,o=Q(n);return"createDriver"in n&&(l=n),"aggregate"in n&&(l=new T.SqliteDialect({database:n})),"getConnection"in n&&(l=new T.MysqlDialect(n)),"connect"in n&&(l=new T.PostgresDialect({pool:n})),{kysely:l?new I.Kysely({dialect:l}):null,databaseType:o}};function B(e,n,l){return l==="update"?e:e==null&&n.defaultValue?typeof n.defaultValue=="function"?n.defaultValue():n.defaultValue:e}var Ie=(e,n,l)=>{let o=v(n);function f(r,i){if(i==="id")return i;let a=o[r].fields[i];return a||console.log("Field not found",r,i),a.fieldName||i}function g(r,i,a){let{type:c="sqlite"}=l||{},u=o[i].fields[a];return u.type==="boolean"&&c==="sqlite"&&r!==null&&r!==void 0?r?1:0:u.type==="date"&&r&&r instanceof Date&&c==="sqlite"?r.toISOString():r}function d(r,i,a){let{type:c="sqlite"}=l||{},u=o[i].fields[a];return u.type==="boolean"&&c==="sqlite"&&r!==null?r===1:u.type==="date"&&r?new Date(r):r}function m(r){return o[r].modelName}let t=n?.advanced?.generateId===!1;return{transformInput(r,i,a){let c=t||a==="update"?{}:{id:n.advanced?.generateId?n.advanced.generateId({model:i}):r.id||F()},u=o[i].fields;for(let s in u){let p=r[s];c[u[s].fieldName||s]=B(g(p,i,s),u[s],a)}return c},transformOutput(r,i,a=[]){if(!r)return null;let c=r.id?a.length===0||a.includes("id")?{id:r.id}:{}:{},u=o[i].fields;for(let s in u){if(a.length&&!a.includes(s))continue;let p=u[s];p&&(c[s]=d(r[p.fieldName||s],i,s))}return c},convertWhereClause(r,i){if(!i)return{and:null,or:null};let a={and:[],or:[]};return i.forEach(c=>{let{field:u,value:s,operator:p="=",connector:A="AND"}=c,y=f(r,u),w=x=>p.toLowerCase()==="in"?x(y,"in",Array.isArray(s)?s:[s]):p==="contains"?x(y,"like",`%${s}%`):p==="starts_with"?x(y,"like",`${s}%`):p==="ends_with"?x(y,"like",`%${s}`):p==="eq"?x(y,"=",s):p==="ne"?x(y,"<>",s):p==="gt"?x(y,">",s):p==="gte"?x(y,">=",s):p==="lt"?x(y,"<",s):p==="lte"?x(y,"<=",s):x(y,p,s);A==="OR"?a.or.push(w):a.and.push(w)}),{and:a.and.length?a.and:null,or:a.or.length?a.or:null}},async withReturning(r,i,a,c){let u;if(l?.type!=="mysql")u=await i.returningAll().executeTakeFirst();else{await i.execute();let s=r.id?"id":c[0].field?c[0].field:"id",p=r[s]||c[0].value;u=await e.selectFrom(m(a)).selectAll().where(f(a,s),"=",p).executeTakeFirst()}return u},getModelName:m,getField:f}},X=(e,n)=>l=>{let{transformInput:o,withReturning:f,transformOutput:g,convertWhereClause:d,getModelName:m,getField:t}=Ie(e,l,n);return{id:"kysely",async create(r){let{model:i,data:a,select:c}=r,u=o(a,i,"create"),s=e.insertInto(m(i)).values(u);return g(await f(u,s,i,[]),i,c)},async findOne(r){let{model:i,where:a,select:c}=r,{and:u,or:s}=d(i,a),p=e.selectFrom(m(i)).selectAll();u&&(p=p.where(y=>y.and(u.map(w=>w(y))))),s&&(p=p.where(y=>y.or(s.map(w=>w(y)))));let A=await p.executeTakeFirst();return A?g(A,i,c):null},async findMany(r){let{model:i,where:a,limit:c,offset:u,sortBy:s}=r,{and:p,or:A}=d(i,a),y=e.selectFrom(m(i));p&&(y=y.where(x=>x.and(p.map(R=>R(x))))),A&&(y=y.where(x=>x.or(A.map(R=>R(x))))),y=y.limit(c||100),u&&(y=y.offset(u)),s&&(y=y.orderBy(t(i,s.field),s.direction));let w=await y.selectAll().execute();return w?w.map(x=>g(x,i)):[]},async update(r){let{model:i,where:a,update:c}=r,{and:u,or:s}=d(i,a),p=o(c,i,"update"),A=e.updateTable(m(i)).set(p);return u&&(A=A.where(w=>w.and(u.map(x=>x(w))))),s&&(A=A.where(w=>w.or(s.map(x=>x(w))))),await g(await f(p,A,i,a),i)},async updateMany(r){let{model:i,where:a,update:c}=r,{and:u,or:s}=d(i,a),p=o(c,i,"update"),A=e.updateTable(m(i)).set(p);return u&&(A=A.where(w=>w.and(u.map(x=>x(w))))),s&&(A=A.where(w=>w.or(s.map(x=>x(w))))),(await A.execute()).length},async delete(r){let{model:i,where:a}=r,{and:c,or:u}=d(i,a),s=e.deleteFrom(m(i));c&&(s=s.where(p=>p.and(c.map(A=>A(p))))),u&&(s=s.where(p=>p.or(u.map(A=>A(p))))),await s.execute()},async deleteMany(r){let{model:i,where:a}=r,{and:c,or:u}=d(i,a),s=e.deleteFrom(m(i));return c&&(s=s.where(p=>p.and(c.map(A=>A(p))))),u&&(s=s.where(p=>p.or(u.map(A=>A(p))))),(await s.execute()).length},options:n}};var Ne=e=>{let n=v(e);function l(o,f){return f==="id"?f:n[o].fields[f].fieldName||f}return{transformInput(o,f,g){let d=g==="update"?{}:{id:e.advanced?.generateId?e.advanced.generateId({model:f}):o.id||F()},m=n[f].fields;for(let t in m){let r=o[t];r===void 0&&!m[t].defaultValue||(d[m[t].fieldName||t]=B(r,m[t],g))}return d},transformOutput(o,f,g=[]){if(!o)return null;let d=o.id||o._id?g.length===0||g.includes("id")?{id:o.id}:{}:{},m=n[f].fields;for(let t in m){if(g.length&&!g.includes(t))continue;let r=m[t];r&&(d[t]=o[r.fieldName||t])}return d},convertWhereClause(o,f,g){return f.filter(d=>o.every(m=>{let{field:t,value:r,operator:i}=m,a=l(g,t);if(i==="in"){if(!Array.isArray(r))throw new Error("Value must be an array");return r.includes(d[a])}else return i==="contains"?d[a].includes(r):i==="starts_with"?d[a].startsWith(r):i==="ends_with"?d[a].endsWith(r):d[a]===r}))},getField:l}},Y=e=>n=>{let{transformInput:l,transformOutput:o,convertWhereClause:f,getField:g}=Ne(n);return{id:"memory",create:async({model:d,data:m})=>{let t=l(m,d,"create");return e[d].push(t),o(t,d)},findOne:async({model:d,where:m,select:t})=>{let r=e[d],a=f(m,r,d)[0]||null;return o(a,d,t)},findMany:async({model:d,where:m,sortBy:t,limit:r,offset:i})=>{let a=e[d];return m&&(a=f(m,a,d)),t&&(a=a.sort((c,u)=>{let s=g(d,t.field);return t.direction==="asc"?c[s]>u[s]?1:-1:c[s]<u[s]?1:-1})),i!==void 0&&(a=a.slice(i)),r!==void 0&&(a=a.slice(0,r)),a.map(c=>o(c,d))},update:async({model:d,where:m,update:t})=>{let r=e[d],i=f(m,r,d);return i.forEach(a=>{Object.assign(a,l(t,d,"update"))}),o(i[0],d)},delete:async({model:d,where:m})=>{let t=e[d],r=f(m,t,d);e[d]=t.filter(i=>!r.includes(i))},deleteMany:async({model:d,where:m})=>{let t=e[d],r=f(m,t,d),i=0;return e[d]=t.filter(a=>r.includes(a)?(i++,!1):!r.includes(a)),i},updateMany(d){let{model:m,where:t,update:r}=d,i=e[m],a=f(t,i,m);return a.forEach(c=>{Object.assign(c,r)}),a[0]||null}}};async function Ue(e){if(!e.database){let o=v(e),f=Object.keys(o).reduce((g,d)=>(g[d]=[],g),{});return Z.warn("No database configuration provided. Using memory adapter in development"),Y(f)(e)}if(typeof e.database=="function")return e.database(e);let{kysely:n,databaseType:l}=await q(e);if(!n)throw new D("Failed to initialize database adapter");return X(n,{type:l||"sqlite"})(e)}function Se(e,n){let l=n.id?{id:n.id}:{};for(let o in e){let f=e[o],g=n[o];g!==void 0&&(l[f.fieldName||o]=g)}return l}function qe(e,n){if(!n)return null;let l={id:n.id};for(let[o,f]of Object.entries(e))l[o]=n[f.fieldName||o];return l}function j(e){let n=v(e),l={};for(let o in n){let f=n[o],g=f.fields,d={};if(Object.entries(g).forEach(([m,t])=>{if(d[t.fieldName||m]=t,t.references){let r=n[t.references.model];r&&(d[t.fieldName||m].references={model:r.modelName,field:t.references.field})}}),l[f.modelName]){l[f.modelName].fields={...l[f.modelName].fields,...d};continue}l[f.modelName]={fields:d,order:f.order||1/0}}return l}var Be={string:["character varying","text"],number:["int4","integer","bigint","smallint","numeric","real","double precision"],boolean:["bool","boolean"],date:["timestamp","date"]},Le={string:["varchar","text"],number:["integer","int","bigint","smallint","decimal","float","double"],boolean:["boolean","tinyint"],date:["timestamp","datetime","date"]},Ee={string:["TEXT"],number:["INTEGER","REAL"],boolean:["INTEGER","BOOLEAN"],date:["DATE","INTEGER"]},Pe={string:["nvarchar","varchar"],number:["int","bigint","smallint","decimal","float","double"],boolean:["bit","boolean"],date:["datetime","date"]},Ve={postgres:Be,mysql:Le,sqlite:Ee,mssql:Pe};function ee(e,n,l){if(n==="string[]"||n==="number[]")return e.toLowerCase().includes("json");let o=Ve[l];return(Array.isArray(n)?o.string.map(d=>d.toLowerCase()):o[n].map(d=>d.toLowerCase())).includes(e.toLowerCase())}async function Me(e){let n=j(e),l=C(e.logger),{kysely:o,databaseType:f}=await q(e);f||(l.warn("Could not determine database type, defaulting to sqlite. Please provide a type in the database options to avoid this."),f="sqlite"),o||(l.error("Only kysely adapter is supported for migrations. You can use `generate` command to generate the schema, if you're using a different adapter."),process.exit(1));let g=await o.introspection.getTables(),d=[],m=[];for(let[c,u]of Object.entries(n)){let s=g.find(A=>A.name===c);if(!s){let A=d.findIndex(x=>x.table===c),y={table:c,fields:u.fields,order:u.order||1/0},w=d.findIndex(x=>(x.order||1/0)>y.order);w===-1?A===-1?d.push(y):d[A].fields={...d[A].fields,...u.fields}:d.splice(w,0,y);continue}let p={};for(let[A,y]of Object.entries(u.fields)){let w=s.columns.find(x=>x.name===A);if(!w){p[A]=y;continue}ee(w.dataType,y.type,f)||l.warn(`Field ${A} in table ${c} has a different type in the database. Expected ${y.type} but got ${w.dataType}.`)}Object.keys(p).length>0&&m.push({table:c,fields:p,order:u.order||1/0})}let t=[];function r(c){let u=c.type,s={string:{sqlite:"text",postgres:"text",mysql:c.unique?"varchar(255)":c.references?"varchar(36)":"text",mssql:"text"},boolean:{sqlite:"integer",postgres:"boolean",mysql:"boolean",mssql:"boolean"},number:{sqlite:"integer",postgres:"integer",mysql:"integer",mssql:"integer"},date:{sqlite:"date",postgres:"timestamp",mysql:"datetime",mssql:"datetime"}};return f==="sqlite"&&(u==="string[]"||u==="number[]")?"text":u==="string[]"||u==="number[]"?"jsonb":Array.isArray(u)?"text":s[u][f||"sqlite"]}if(m.length)for(let c of m)for(let[u,s]of Object.entries(c.fields)){let p=r(s),A=o.schema.alterTable(c.table).addColumn(u,p,y=>(y=s.required!==!1?y.notNull():y,s.references&&(y=y.references(`${s.references.model}.${s.references.field}`)),s.unique&&(y=y.unique()),y));t.push(A)}if(d.length)for(let c of d){let u=o.schema.createTable(c.table).addColumn("id",f==="mysql"?"varchar(36)":"text",s=>s.primaryKey().notNull());for(let[s,p]of Object.entries(c.fields)){let A=r(p);u=u.addColumn(s,A,y=>(y=p.required!==!1?y.notNull():y,p.references&&(y=y.references(`${p.references.model}.${p.references.field}`)),p.unique&&(y=y.unique()),y))}t.push(u)}async function i(){for(let c of t)await c.execute()}async function a(){return t.map(u=>u.compile().sql).join(`;

`)}return{toBeCreated:d,toBeAdded:m,runMigrations:i,compileMigrations:a}}0&&(module.exports={convertFromDB,convertToDB,createFieldAttribute,createInternalAdapter,getAdapter,getAuthTables,getMigrations,getSchema,getWithHooks,matchType,toZodSchema});
