"use strict";var v=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var M=(e,a)=>{for(var n in a)v(e,n,{get:a[n],enumerable:!0})},V=(e,a,n,c)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of L(a))!E.call(e,r)&&r!==n&&v(e,r,{get:()=>a[r],enumerable:!(c=q(a,r))||c.enumerable});return e};var P=e=>V(v({},"__esModule",{value:!0}),e);var fe={};M(fe,{mongodbAdapter:()=>le});module.exports=P(fe);var h=require("mongodb");var o=require("zod"),_=require("better-call"),ye=o.z.object({id:o.z.string(),providerId:o.z.string(),accountId:o.z.string(),userId:o.z.string(),accessToken:o.z.string().nullish(),refreshToken:o.z.string().nullish(),idToken:o.z.string().nullish(),accessTokenExpiresAt:o.z.date().nullish(),refreshTokenExpiresAt:o.z.date().nullish(),scope:o.z.string().nullish(),password:o.z.string().nullish(),image:o.z.string().nullish(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date)}),ge=o.z.object({id:o.z.string(),email:o.z.string().transform(e=>e.toLowerCase()),emailVerified:o.z.boolean().default(!1),name:o.z.string(),image:o.z.string().nullish(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date)}),Ae=o.z.object({id:o.z.string(),userId:o.z.string(),expiresAt:o.z.date(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date),token:o.z.string(),ipAddress:o.z.string().nullish(),userAgent:o.z.string().nullish()}),he=o.z.object({id:o.z.string(),value:o.z.string(),createdAt:o.z.date().default(()=>new Date),updatedAt:o.z.date().default(()=>new Date),expiresAt:o.z.date(),identifier:o.z.string()});var b=Object.create(null),w=e=>globalThis.process?.env||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?b:globalThis),I=new Proxy(b,{get(e,a){return w()[a]??b[a]},has(e,a){let n=w();return a in n||a in b},set(e,a,n){let c=w(!0);return c[a]=n,!0},deleteProperty(e,a){if(!a)return!1;let n=w(!0);return delete n[a],!0},ownKeys(){let e=w(!0);return Object.keys(e)}});function C(e){return e?e!=="false":!1}var $=typeof process<"u"&&process.env&&process.env.NODE_ENV||"";var j=$==="test"||C(I.TEST);var H=require("@better-auth/utils/random");var re=require("zod"),ne=require("better-call");var Y=require("@better-auth/utils/hash"),ee=require("@noble/ciphers/chacha"),k=require("@noble/ciphers/utils"),te=require("@noble/ciphers/webcrypto");var J=require("@better-auth/utils/hash");var z=require("jose");var G=require("@noble/hashes/scrypt"),Z=require("uncrypto"),Q=require("@better-auth/utils/hex");var F=require("@better-auth/utils/random"),X=(0,F.createRandomStringGenerator)("a-z","0-9","A-Z","-_");var O=["info","success","warn","error","debug"];function ie(e,a){return O.indexOf(a)<=O.indexOf(e)}var g={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},se={info:g.fg.blue,success:g.fg.green,warn:g.fg.yellow,error:g.fg.red,debug:g.fg.magenta},ae=(e,a)=>{let n=new Date().toISOString();return`${g.dim}${n}${g.reset} ${se[e]}${e.toUpperCase()}${g.reset} ${g.bright}[Better Auth]:${g.reset} ${a}`},N=e=>{let a=e?.disabled!==!0,n=e?.level??"error",c=(r,i,t=[])=>{if(!a||!ie(n,r))return;let s=ae(r,i);if(!e||typeof e.log!="function"){r==="error"?console.error(s,...t):r==="warn"?console.warn(s,...t):console.log(s,...t);return}e.log(r==="success"?"info":r,s,...t)};return Object.fromEntries(O.map(r=>[r,(...[i,...t])=>c(r,i,t)]))},oe=N();var x=e=>{let a=e.plugins?.reduce((d,l)=>{let u=l.schema;if(!u)return d;for(let[f,A]of Object.entries(u))d[f]={fields:{...d[f]?.fields,...A.fields},modelName:A.modelName||f};return d},{}),n=e.rateLimit?.storage==="database",c={rateLimit:{modelName:e.rateLimit?.modelName||"rateLimit",fields:{key:{type:"string",fieldName:e.rateLimit?.fields?.key||"key"},count:{type:"number",fieldName:e.rateLimit?.fields?.count||"count"},lastRequest:{type:"number",fieldName:e.rateLimit?.fields?.lastRequest||"lastRequest"}}}},{user:r,session:i,account:t,...s}=a||{};return{user:{modelName:e.user?.modelName||"user",fields:{name:{type:"string",required:!0,fieldName:e.user?.fields?.name||"name"},email:{type:"string",unique:!0,required:!0,fieldName:e.user?.fields?.email||"email"},emailVerified:{type:"boolean",defaultValue:()=>!1,required:!0,fieldName:e.user?.fields?.emailVerified||"emailVerified"},image:{type:"string",required:!1,fieldName:e.user?.fields?.image||"image"},createdAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",defaultValue:()=>new Date,required:!0,fieldName:e.user?.fields?.updatedAt||"updatedAt"},...r?.fields,...e.user?.additionalFields},order:1},session:{modelName:e.session?.modelName||"session",fields:{expiresAt:{type:"date",required:!0,fieldName:e.session?.fields?.expiresAt||"expiresAt"},token:{type:"string",required:!0,fieldName:e.session?.fields?.token||"token",unique:!0},createdAt:{type:"date",required:!0,fieldName:e.session?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.session?.fields?.updatedAt||"updatedAt"},ipAddress:{type:"string",required:!1,fieldName:e.session?.fields?.ipAddress||"ipAddress"},userAgent:{type:"string",required:!1,fieldName:e.session?.fields?.userAgent||"userAgent"},userId:{type:"string",fieldName:e.session?.fields?.userId||"userId",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0},...i?.fields,...e.session?.additionalFields},order:2},account:{modelName:e.account?.modelName||"account",fields:{accountId:{type:"string",required:!0,fieldName:e.account?.fields?.accountId||"accountId"},providerId:{type:"string",required:!0,fieldName:e.account?.fields?.providerId||"providerId"},userId:{type:"string",references:{model:e.user?.modelName||"user",field:"id",onDelete:"cascade"},required:!0,fieldName:e.account?.fields?.userId||"userId"},accessToken:{type:"string",required:!1,fieldName:e.account?.fields?.accessToken||"accessToken"},refreshToken:{type:"string",required:!1,fieldName:e.account?.fields?.refreshToken||"refreshToken"},idToken:{type:"string",required:!1,fieldName:e.account?.fields?.idToken||"idToken"},accessTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"accessTokenExpiresAt"},refreshTokenExpiresAt:{type:"date",required:!1,fieldName:e.account?.fields?.accessTokenExpiresAt||"refreshTokenExpiresAt"},scope:{type:"string",required:!1,fieldName:e.account?.fields?.scope||"scope"},password:{type:"string",required:!1,fieldName:e.account?.fields?.password||"password"},createdAt:{type:"date",required:!0,fieldName:e.account?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!0,fieldName:e.account?.fields?.updatedAt||"updatedAt"},...t?.fields},order:3},verification:{modelName:e.verification?.modelName||"verification",fields:{identifier:{type:"string",required:!0,fieldName:e.verification?.fields?.identifier||"identifier"},value:{type:"string",required:!0,fieldName:e.verification?.fields?.value||"value"},expiresAt:{type:"date",required:!0,fieldName:e.verification?.fields?.expiresAt||"expiresAt"},createdAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.createdAt||"createdAt"},updatedAt:{type:"date",required:!1,defaultValue:()=>new Date,fieldName:e.verification?.fields?.updatedAt||"updatedAt"}},order:4},...s,...n?c:{}}};var de=require("zod");var U=require("kysely"),D=require("kysely");function T(e,a,n){return n==="update"?e:e==null&&a.defaultValue?typeof a.defaultValue=="function"?a.defaultValue():a.defaultValue:e}var ce=e=>{let a=x(e);function n(i,t,s){if(i==="id"||i==="_id"||a[s].fields[i].references?.field==="id"){if(typeof t!="string"){if(t instanceof h.ObjectId)return t;if(Array.isArray(t))return t.map(d=>{if(typeof d=="string")try{return new h.ObjectId(d)}catch{return d}if(d instanceof h.ObjectId)return d;throw new Error("Invalid id value")});throw new Error("Invalid id value")}try{return new h.ObjectId(t)}catch{return t}}return t}function c(i,t,s){return i==="id"||a[s].fields[i].references?.field==="id"?t instanceof h.ObjectId?t.toHexString():Array.isArray(t)?t.map(d=>d instanceof h.ObjectId?d.toHexString():d):t:t}function r(i,t){return i==="id"?"_id":a[t].fields[i].fieldName||i}return{transformInput(i,t,s){let d=s==="update"?{}:{_id:new h.ObjectId},l=a[t].fields;for(let u in l){let f=i[u];f===void 0&&(!l[u].defaultValue||s==="update")||(d[l[u].fieldName||u]=T(n(u,f,t),l[u],s))}return d},transformOutput(i,t,s=[]){let d=i.id||i._id?s.length===0||s.includes("id")?{id:i.id?i.id.toString():i._id.toString()}:{}:{},l=a[t].fields;for(let u in l){if(s.length&&!s.includes(u))continue;let f=l[u];f&&(d[u]=c(u,i[f.fieldName||u],t))}return d},convertWhereClause(i,t){if(!i.length)return{};let s=i.map(f=>{let{field:A,value:p,operator:R="eq",connector:B="AND"}=f,m,y=r(A,t);switch(R.toLowerCase()){case"eq":m={[y]:n(A,p,t)};break;case"in":m={[y]:{$in:Array.isArray(p)?n(A,p,t):[n(A,p,t)]}};break;case"gt":m={[y]:{$gt:p}};break;case"gte":m={[y]:{$gte:p}};break;case"lt":m={[y]:{$lt:p}};break;case"lte":m={[y]:{$lte:p}};break;case"ne":m={[y]:{$ne:p}};break;case"contains":m={[y]:{$regex:`.*${p}.*`}};break;case"starts_with":m={[y]:{$regex:`${p}.*`}};break;case"ends_with":m={[y]:{$regex:`.*${p}`}};break;default:throw new Error(`Unsupported operator: ${R}`)}return{condition:m,connector:B}});if(s.length===1)return s[0].condition;let d=s.filter(f=>f.connector==="AND").map(f=>f.condition),l=s.filter(f=>f.connector==="OR").map(f=>f.condition),u={};return d.length&&(u={...u,$and:d}),l.length&&(u={...u,$or:l}),u},getModelName:i=>a[i].modelName,getField:r}},le=e=>a=>{let n=ce(a);return{id:"mongodb-adapter",async create(c){let{model:r,data:i,select:t}=c,s=n.transformInput(i,r,"create");s.id&&delete s.id;let l=(await e.collection(n.getModelName(r)).insertOne(s)).insertedId,u={...s,id:l.toString()};return n.transformOutput(u,r,t)},async findOne(c){let{model:r,where:i,select:t}=c,s=n.convertWhereClause(i,r),d=await e.collection(n.getModelName(r)).findOne(s);return d?n.transformOutput(d,r,t):null},async findMany(c){let{model:r,where:i,limit:t,offset:s,sortBy:d}=c,l=i?n.convertWhereClause(i,r):{},u=e.collection(n.getModelName(r)).find(l);return t&&u.limit(t),s&&u.skip(s),d&&u.sort(n.getField(d.field,r),d.direction==="desc"?-1:1),(await u.toArray()).map(A=>n.transformOutput(A,r))},async update(c){let{model:r,where:i,update:t}=c,s=n.convertWhereClause(i,r),d=n.transformInput(t,r,"update"),l=await e.collection(n.getModelName(r)).findOneAndUpdate(s,{$set:d},{returnDocument:"after"});return l?n.transformOutput(l,r):null},async updateMany(c){let{model:r,where:i,update:t}=c,s=n.convertWhereClause(i,r),d=n.transformInput(t,r,"update");return(await e.collection(n.getModelName(r)).updateMany(s,{$set:d})).modifiedCount},async delete(c){let{model:r,where:i}=c,t=n.convertWhereClause(i,r),s=await e.collection(n.getModelName(r)).findOneAndDelete(t);return s?n.transformOutput(s,r):null},async deleteMany(c){let{model:r,where:i}=c,t=n.convertWhereClause(i,r);return(await e.collection(n.getModelName(r)).deleteMany(t)).deletedCount}}};0&&(module.exports={mongodbAdapter});
